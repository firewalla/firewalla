#!/bin/bash

rc=0

: ${NM_DIR:=/home/pi/.node_modules}
: ${FIREWALLA_HOME:=/home/pi/firewalla}

cd ${FIREWALLA_HOME}

CPU_PLATFORM=$(uname -m)
branch=$(git rev-parse --abbrev-ref HEAD)

NODE_VERSION=$(${FIREWALLA_HOME}/bin/node -v 2>/dev/null)

NM_ARM_NODE8_URL=https://github.com/firewalla/fnm.node8.armv7l.git
NM_ARM_NODE4_URL=https://github.com/firewalla/firewalla_nodemodules.git

set_origin() {
   branch=$1
   node_url=$2

   # make sure node_modules use the right repo
   ( cd $NM_DIR

   NM_URL=$(git remote get-url origin)
   
   if [[ "$NM_URL" != "$node_url" ]]; then
     git remote set-url origin $node_url

     # no need to pull, main-start will handle pull and revision reset
     # git pull origin $branch
   fi  
   ) || return 1

   return 0
   
}

if [[ $CPU_PLATFORM == "armv7l" ]]; then
    if [[ ${NODE_VERSION:0:2} == 'v8' ]]; then
        node_url=$NM_ARM_NODE8_URL
    elif [[ ${NODE_VERSION:0:2} == 'v4' ]]; then
        node_url=$NM_ARM_NODE4_URL
    fi
    set_origin $branch $node_url || rc=1
fi

exit $rc




