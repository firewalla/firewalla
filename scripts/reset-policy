#!/bin/bash -

/home/pi/firewalla/scripts/fire-stop
redis-cli KEYS "policy:*" | while IFS= read -r line; do
  if [[ "$line" =~ policy:[0-9]+ ]]; then
    redis-cli DEL $line
  elif [[ "$line" == policy:mac:* || "$line" == policy:wg_peer:* ]]; then
    tags=$(redis-cli HGET $line tags)
    user_tags=$(redis-cli HGET $line userTags)
    redis-cli DEL "$line"
    if [[ -n "$tags" ]]; then
      redis-cli HSET "$line" tags "$tags"
    fi
    if [[ -n "$user_tags" ]]; then
      redis-cli HSET "$line" userTags "$user_tags"
    fi
  elif [[ "$line" == policy:tag:* ]]; then
    user_tags=$(redis-cli HGET $line userTags)
    redis-cli DEL "$line"
    if [[ -n "$user_tags" ]]; then
      redis-cli HSET "$line" userTags "$user_tags"
    fi
  elif [[ "$line" == policy:network:* || "$line" == "policy:system" || "$line" == "policy:id" || "$line" == "policy:state"  ]]; then
    redis-cli DEL "$line"
  else
    # do nothing
    :
  fi
done
redis-cli DEL "policy_qos_handler_map"
redis-cli HDEL "sys:config" "default_c_init_done"
redis-cli bgsave
sync
logger "REBOOT: User Reset Policy"
/home/pi/firewalla/scripts/fire-reboot-normal
