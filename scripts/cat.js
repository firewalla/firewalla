/*    Copyright 2019 Firewalla INC
 *
 *    This program is free software: you can redistribute it and/or  modify
 *    it under the terms of the GNU Affero General Public License, version 3,
 *    as published by the Free Software Foundation.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU Affero General Public License for more details.
 *
 *    You should have received a copy of the GNU Affero General Public License
 *    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _0x1f98=['device','Error:\x20argument\x20device\x20or\x20ip\x20is\x20required','exit','prototype','valueOf','abs','length','max','join','charAt','host:mac:','hgetAsync','ipv4Addr','host:ip4:','mac','log','Mac\x20Address:','padding','name','Provisioned\x20Name:','bname','IP\x20Address:','ipv6Addr','parse','forEach','IPv6\x20Address:','lastActiveTimestamp','Last\x20Active\x20Timestamp:','toLocaleString','\x0a------------\x20Recent\x20Outgoing\x20Flows\x20-------------','Remote\x20IP\x20Address','Download','flow:conn:in:','\x0a------------\x20Recent\x20Incoming\x20Flows\x20-------------','Timestamp','Upload','Duration','flow:conn:out:','zrevrangeAsync','_ts','keys','replace','tcp:','udp:','commander','redis','createClient','bluebird','promisifyAll','version','0.0.2','--device\x20[mac\x20address]','device\x20mac\x20address','option','device\x20ip\x20address','argv'];(function(_0x4501a1,_0x549817){var _0x2e9907=function(_0x4e0a2c){while(--_0x4e0a2c){_0x4501a1['push'](_0x4501a1['shift']());}};_0x2e9907(++_0x549817);}(_0x1f98,0x64));var _0x93f7=function(_0x1d7e82,_0x483860){_0x1d7e82=_0x1d7e82-0x0;var _0x5d969a=_0x1f98[_0x1d7e82];return _0x5d969a;};'use strict';const program=require(_0x93f7('0x0'));const rclient=require(_0x93f7('0x1'))[_0x93f7('0x2')]();const Promise=require(_0x93f7('0x3'));Promise[_0x93f7('0x4')](rclient);program[_0x93f7('0x5')](_0x93f7('0x6'))['option'](_0x93f7('0x7'),_0x93f7('0x8'))[_0x93f7('0x9')]('--ip\x20[ip\x20address]',_0x93f7('0xa'));program['parse'](process[_0x93f7('0xb')]);if(program[_0x93f7('0xc')]==null&&program['ip']==null){console['error'](_0x93f7('0xd'));process[_0x93f7('0xe')](0x1);}String[_0x93f7('0xf')]['padding']=function(_0x17c11f,_0x434c44){var _0x3c1777=this[_0x93f7('0x10')]();if(Math[_0x93f7('0x11')](_0x17c11f)<=_0x3c1777[_0x93f7('0x12')]){return _0x3c1777;}var _0x3dcd7a=Math[_0x93f7('0x13')](Math[_0x93f7('0x11')](_0x17c11f)-this[_0x93f7('0x12')]||0x0,0x0);var _0x563055=Array(_0x3dcd7a+0x1)[_0x93f7('0x14')](String(_0x434c44||'\x20')[_0x93f7('0x15')](0x0));return _0x17c11f<0x0?_0x563055+_0x3c1777:_0x3c1777+_0x563055;};function get_key(_0x1d9a28){return _0x93f7('0x16')+_0x1d9a28;}async function get_value(_0x1fcdb0,_0x445e04){return rclient[_0x93f7('0x17')](get_key(_0x1fcdb0),_0x445e04);}async function get_ip(_0x412682){return get_value(_0x412682,_0x93f7('0x18'));}async function get_mac(_0x5402a4){return rclient[_0x93f7('0x17')](_0x93f7('0x19')+_0x5402a4,_0x93f7('0x1a'));}async function print_device(_0x12834c){console[_0x93f7('0x1b')](_0x93f7('0x1c')[_0x93f7('0x1d')](0x19),_0x12834c);const _0x2d5324=(await get_value(_0x12834c,_0x93f7('0x1e')))||'';console[_0x93f7('0x1b')](_0x93f7('0x1f')[_0x93f7('0x1d')](0x19),_0x2d5324);const _0x2b8d8e=await get_value(_0x12834c,_0x93f7('0x20'));console[_0x93f7('0x1b')]('Discovered\x20Name:'['padding'](0x19),_0x2b8d8e);const _0x159dd0=await get_value(_0x12834c,'ipv4Addr');console[_0x93f7('0x1b')](_0x93f7('0x21')[_0x93f7('0x1d')](0x19),_0x159dd0);const _0x53792d=await get_value(_0x12834c,_0x93f7('0x22'));try{const _0x2d98d5=JSON[_0x93f7('0x23')](_0x53792d);if(_0x2d98d5&&_0x2d98d5[_0x93f7('0x12')]>0x0){_0x2d98d5[_0x93f7('0x24')](_0x259be9=>{console[_0x93f7('0x1b')](_0x93f7('0x25')['padding'](0x19),_0x259be9);});}}catch(_0x168939){}const _0xed287b=await get_value(_0x12834c,_0x93f7('0x26'));const _0x420c9b=new Date(Number(_0xed287b)*0x3e8);console['log'](_0x93f7('0x27')[_0x93f7('0x1d')](0x19),_0x420c9b[_0x93f7('0x28')]());}async function print_flow(_0x3dcaf2,_0x20613d){console[_0x93f7('0x1b')](_0x93f7('0x29'));console[_0x93f7('0x1b')]('Timestamp'['padding'](0x19),_0x93f7('0x2a')[_0x93f7('0x1d')](0x14),'Port'[_0x93f7('0x1d')](0x8),'Upload'[_0x93f7('0x1d')](0xa),_0x93f7('0x2b')[_0x93f7('0x1d')](0xa),'Duration'[_0x93f7('0x1d')](0xa));await _print_flow(_0x93f7('0x2c')+_0x3dcaf2);await _print_flow(_0x93f7('0x2c')+_0x20613d);console[_0x93f7('0x1b')](_0x93f7('0x2d'));console[_0x93f7('0x1b')](_0x93f7('0x2e')[_0x93f7('0x1d')](0x19),_0x93f7('0x2a')['padding'](0x14),'Port'[_0x93f7('0x1d')](0x8),_0x93f7('0x2f')[_0x93f7('0x1d')](0xa),_0x93f7('0x2b')[_0x93f7('0x1d')](0xa),_0x93f7('0x30')['padding'](0xa));await _print_flow(_0x93f7('0x31')+_0x3dcaf2);await _print_flow(_0x93f7('0x31')+_0x20613d);}async function _print_flow(_0x3f81c7){const _0xd5a450=await rclient[_0x93f7('0x32')](_0x3f81c7,0x0,0x13);_0xd5a450[_0x93f7('0x24')](_0x54231a=>{try{const _0x16bf65=JSON['parse'](_0x54231a);print_flow_line(_0x16bf65);}catch(_0x36c39c){}});}function print_num(_0x33ec3f){return(''+_0x33ec3f)[_0x93f7('0x1d')](0xa);}async function print_flow_line(_0x5ea727,_0x50ce5d){_0x5ea727=_0x5ea727||{};const _0xca234a=_0x5ea727[_0x93f7('0x33')]||0x0;const _0x8ca3fb=new Date(_0xca234a*0x3e8)['toLocaleString']();const _0x1ed1bc=_0x5ea727['lh']===_0x5ea727['sh']?_0x5ea727['dh']:_0x5ea727['sh'];const _0x1cec72=_0x5ea727['ob']||0x0;const _0xcfa8fc=_0x5ea727['rb']||0x0;const _0x34640d=_0x5ea727['du']||0x0;const _0x4f45cd=_0x5ea727['pf']||{};const _0x5b0b2b=Object[_0x93f7('0x34')](_0x4f45cd);let _0x4012b0='0';if(_0x5b0b2b[_0x93f7('0x12')]>0x0){_0x4012b0=_0x5b0b2b[0x0][_0x93f7('0x35')](_0x93f7('0x36'),'')[_0x93f7('0x35')](_0x93f7('0x37'),'');}console[_0x93f7('0x1b')](_0x8ca3fb['padding'](0x19),_0x1ed1bc['padding'](0x14),_0x4012b0['padding'](0x8),print_num(_0x1cec72),print_num(_0xcfa8fc),print_num(_0x34640d));}let mac=program[_0x93f7('0xc')];(async()=>{if(!mac){mac=await get_mac(program['ip']);}await print_device(mac);const _0x1f3327=await get_ip(mac);await print_flow(_0x1f3327,mac);process[_0x93f7('0xe')](0x0);})();